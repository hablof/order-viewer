## Order-viewer

Данный сервис выполняет простейшие функции: 
* принимает посылки **данных о заказе** в json формате из канала `NATS-Streaming`
* сохраняет их базу данных `PostgreSQL`
* так же хранит эти данные у себя в памяти (кэш)
* предоставляет `http api` для просмотра данных о заказе с простейшим интерфейсом
* при запуске приложения считывает данне из базы и помещает их в кэш

### http api
Всего один эндпоинт:
* *GET* `/orders/{order_id}`, где `order_id` это _id_ заказа.

Если заказ, с указанным _id_ существует, то будет выведена информация о заказе и о товарах заказа. Статус-код http ответа `200`.

Если заказа, с указанным _id_ нет, будет выведено сообщение о том, что заказ с указанным _id_ не найден. Статус-код http ответа `404`.

### PostgreSQL 
Реляционная модель данных представлена несколькими таблицами:
* `orders` - основные данные о заказе.
* `delivery` - данные о доставке. Имеет отношение один-к-одному с таблицей `orders`.
* `payment` - данные о платеже. Имеет отношение один-к-одному с таблицей `orders`.
* `item` - данные о заказанных товарах. Имеет отношение один-ко-многим с таблицей `orders`.

Свойство _PRIMARY KEY_ (обеспечивающее _b-tree_ индекс + ограничение уникальности) установлено на столбцах `order_uid`, `delivery_id`, `transaction`  таблиц `orders`, `delivery`, `payment` соответственно. Так же _b-tree_ индекс установлен на столбце `order_uid` талице `item`. Именно по эим столбцам происходит операции _JOIN_ и _WHERE_ в запросах.

### Хранение данных в памяти
Для хранения данных в кеше используется структура состоящая из:
* _хеш-мапы_ с ключём в виде  _id_ заказа (собственно данные),
* _мьютекса_ для обеспечения горутинобезопасного доступа к данным.

### Подписка NATS-Streaming
Используется тип подписки _Durable_ + _QueueGroup_ 
* _Durable_ - то есть сам сервер запоминает последнее прочитанное группой сообщение и, в случае переподключения (или подключения новогого) подписчика группы начинает пересылать ещё не прочитанные подписчиком сообщения. Сервер игнорирует запрашиваемую подписчиками позицию.
* _QueueGroup_ - сообщения разделяются между группой подписчиков. Т.е. одно сообщение может быть прочитано только одним подписчиком группы. В кофигурации приложения можно задать количество конкурентных подписчиков.

### Организация кода
Код разделён на пакеты `cache`, `repository`, `service`, `httpcontroller` и т.д. 

Структура заказа описана в отдельном пакете `models`.

Взаимодействие между пакетами осуществляется с помощю механизма интерфейсов языка Go.

Зацепление (coupling): пакет `models` не импортирует никакие другие пакеты приложения, пакет `service` импортирует только пакет `models`.

### Конфигурация
Приложение читает стандартную конфигурацию из файла `default_config.yaml`.

Имеется возможность переопределить путь до файла конфига, задав переменную окружения `CFGFILENAME`.

Отдельно передаётся пароль к базе данных через пересенную окружения `PSQLPASS`.
